<element name="b-collapsible">
    <style>
        b-collapsible {
            display: block;
            overflow: hidden;
        }
        
        b-collapsible.b-collapsible-closed {
            display: none;
        }
    </style>
    <script>
        (function(){
            window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
                window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;

            var CLOSED_CLASS = 'b-collapsible-closed';

            Bosonic.register({
                get active() {
                    return this.hasAttribute('active');
                },

                set active(value) {
                    value ? this.setAttribute('active', '') : this.removeAttribute('active');
                },

                createdCallback: function() {
                    this.init();
                },

                init: function() {
                    this.duration = this.hasAttribute('duration') ? parseFloat(this.getAttribute('duration')) : 0.33;
                    this.dimension = this.hasAttribute('horizontal') ? 'width' : 'height';
                    
                    if (this.supportsTransitions()) {
                        if (this.active) {
                            this.setSize('auto');
                        }
                    }
                    this.addListeners();
                    this.toggleClosedClass(!this.active);
                },

                detachedCallback: function() {
                    this.removeListeners();
                },

                addListeners: function() {
                    if (this.supportsTransitions()) {
                        this.transitionEndListener = this.transitionEnd.bind(this);
                        this.addEventListener('webkitTransitionEnd', this.transitionEndListener);
                        this.addEventListener('transitionend', this.transitionEndListener);
                    }
                },

                removeListeners: function() {
                    if (this.supportsTransitions()) {
                        this.removeEventListener('webkitTransitionEnd', this.transitionEndListener);
                        this.removeEventListener('transitionend', this.transitionEndListener);
                    }
                },

                attributeChangedCallback: function(name, oldValue, newValue) {
                    if (name === 'active') this.activeChanged(oldValue, newValue);
                },

                toggle: function() {
                    if (!this.dispatchEvent(new CustomEvent('b-collapsible-toggle', { cancelable: true }))) return;
                    this.active = !this.active;
                },

                activeChanged: function(oldValue, newValue) {
                    this.update();
                },

                update: function() {
                    this.active ? this.show() : this.hide();
                },

                show: function() {
                    if (!this.dispatchEvent(new CustomEvent('b-collapsible-show', { cancelable: true }))) return;

                    this.toggleClosedClass(false);
                    if (this.supportsTransitions()) {
                        this.updateSize('auto', null);
                        var s = this.computeSize();
                        this.updateSize(0, null);
                        window.requestAnimationFrame(function() {
                            this.updateSize(this.size || s, this.duration, true);
                        }.bind(this));
                    }
                },

                hide: function() {
                    if (!this.dispatchEvent(new CustomEvent('b-collapsible-hide', { cancelable: true }))) return;

                    if (!this.supportsTransitions()) {
                        this.toggleClosedClass(true);
                        return;
                    }
                    this.updateSize(this.computeSize(), null);
                    window.requestAnimationFrame(function() {
                        this.updateSize(0, this.duration);
                    }.bind(this));
                },

                updateSize: function(size, duration, forceEnd) {
                    if (duration) {
                        this.computeSize();
                    }
                    this.setTransitionDuration(duration);
                    var nochange = this.style[this.dimension] === size;
                    this.style[this.dimension] = size;
                    // transitionEnd will not be called if the size has not changed
                    // if (forceEnd && nochange) {
                    //     this.transitionEnd();
                    // }
                },

                computeSize: function() {
                    return this.getBoundingClientRect()[this.dimension] + 'px';
                },

                setSize: function(size) {
                    this.style[this.dimension] = size;
                },

                setTransitionDuration: function(duration) {
                    this.style.webkitTransition = this.style.transition = duration ? (this.dimension + ' ' + duration + 's') : null;
                    if (duration === 0) {
                        var that = this;
                        window.requestAnimationFrame(function() {
                            this.transitionEnd();
                        }.bind(this));
                    }
                },

                toggleClosedClass: function(closed) {
                    closed ? this.classList.add(CLOSED_CLASS) : this.classList.remove(CLOSED_CLASS);
                },

                transitionEnd: function() {
                    if (this.active) {
                        this.updateSize('auto', null);
                    }
                    this.setTransitionDuration(null);
                    this.toggleClosedClass(!this.active);
                },

                supportsTransitions: function() {
                    return window.requestAnimationFrame !== undefined;
                }
            });
        })();
    </script>
</element>
