<element name="b-dialog">
    <style>
        b-dialog {
            display: block;
            position: fixed;
            top: 50%;
            left: 50%;
            height: auto;
            z-index: 102;
            visibility: hidden;
            box-sizing: border-box;
            transform: translateX(-50%) translateY(-50%);
            /* minimum styling */
            background-color: white;
            border: var(--b-dialog-border);
        }

        b-dialog[visible] {
            visibility: visible;
        }

        .b-overlay {
            display: block;
            position: fixed;
            z-index: 101;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: black;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .b-overlay[opened] {
            opacity: 0.5;
        }
    </style>
    <script>
        (function(){
            var KEY = {
                ENTER: 13,
                ESC: 27,
                TAB: 9
            };

            var focusableElementsSelector ="a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]";

            function getFocusableElements(container) {
                return container.querySelectorAll(focusableElementsSelector);
            }

            function getFirstFocusableElement(container) {
                return container.querySelector(focusableElementsSelector);
            }

            Bosonic.register({
                attachedCallback: function() {
                    this.tabIndex = -1;
                    this.setAttribute('role', 'dialog');
                    this.setAttribute('aria-hidden', 'true');
                },

                show: function() {
                    this.setAttribute('visible', '');
                    this.setAttribute('aria-hidden', 'false');
                    this.keydownListener = this.onKeydown.bind(this);
                    document.addEventListener('keydown', this.keydownListener, false);
                    this.clickListener = this.onDialogClick.bind(this);
                    this.addEventListener('click', this.clickListener);
                    this.grabFocus();
                    if (this.overlay) {
                        this.overlay.setAttribute('opened', '');
                    }
                },

                showModal: function() {
                    this.appendOverlay();
                    this.show();
                },

                appendOverlay: function() {
                    this.overlay = document.createElement('div');
                    this.overlay.classList.add('b-overlay');
                    this.parentNode.appendChild(this.overlay);
                },

                grabFocus: function() {
                    this.previouslyFocusedElement = document.querySelector(':focus');
                    var firstFocusableElement = getFirstFocusableElement(this);
                    if (firstFocusableElement) {
                        firstFocusableElement.focus();
                    } else {
                        this.focus();
                    }
                },

                releaseFocus: function() {
                    if (this.previouslyFocusedElement) {
                        this.previouslyFocusedElement.focus();
                        this.previouslyFocusedElement = null;
                    }
                },

                trapFocus: function(e) {
                    var focusableElements = getFocusableElements(this),
                        currentlyFocused = this.querySelector(':focus'),
                        currentlyFocusedIndex = Array.prototype.indexOf.call(focusableElements, currentlyFocused),
                        lastFocusableElementIndex = focusableElements.length - 1;
                    
                    if (e.shiftKey && currentlyFocusedIndex === 0) {
                        focusableElements.item(lastFocusableElementIndex).focus();
                        e.preventDefault();
                    } else if (!e.shiftKey && currentlyFocusedIndex === lastFocusableElementIndex) {
                        focusableElements.item(0).focus();
                        e.preventDefault();
                    }
                },

                onKeydown: function(e) {
                    switch(e.which) {
                        case KEY.ESC: {
                            this.cancel();
                            break;
                        }
                        case KEY.TAB: {
                            this.trapFocus(e);
                            break;
                        }
                        default:
                            return;
                    }
                },

                onDialogClick: function(e) {
                    var target = e.target;
                    while (target && target !== this) {
                        if (target.hasAttribute && (target.hasAttribute('data-dialog-dismiss') || target.hasAttribute('dialog-dismiss'))) {
                            this.close();
                        }
                        target = target.parentNode;
                    }
                },

                hide: function() {
                    this.releaseFocus();
                    this.removeAttribute('visible');
                    this.setAttribute('aria-hidden', 'true');
                    if (this.overlay) {
                        // TODO: needs to use 'transitionend' in order to properly transition when hiding the overlay
                        //this.overlay.removeAttribute('opened');
                        this.parentNode.removeChild(this.overlay);
                        this.overlay = null;
                    }
                    document.removeEventListener('keydown', this.keydownListener, false);
                    this.removeEventListener('click', this.clickListener);
                    this.dispatchEvent(new CustomEvent('b-dialog-close'));
                },

                close: function() {
                    this.hide();
                },

                open: function() {
                    this.show();
                },

                cancel: function() {
                    var doCancel = this.dispatchEvent(new CustomEvent('b-dialog-cancel', { cancelable: true }));
                    if (doCancel) {
                        this.hide();
                    }
                }
            });
        })();
    </script>
</element>